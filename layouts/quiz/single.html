{{ define "main" }}
{{ $quiz := getJSON .Params.json_file }}
{{ $debug := ne (getenv "HUGO_ENV") "production" }}

<main id="app" class="mw8 w-100 pa3 {{ if 0 }}debug debug-grid-16{{ end }}">
  <div class="black-70 pb3">
    <h1 class="f-headline-l lh-title mt3">{{ .Params.title }}</h1>
    <p class="lh-copy measure fw4 f4 f3-ns">{{ .Params.description }}</p>
  </div>

  {{ range $i, $q := $quiz.questions }}
  {{ $j := add $i 1 }}
  <div id="q{{ $j }}" class="w-100 mb4">
    <h2 class="f3 f2-ns lh-title">{{ $j }}. {{ .text }}</h2>
    {{ $has_image := index (0 | index .answers) "image"  }}
    {{ if and (not $has_image) .image }}<img class="w-100 w-60-ns br4 o-80" src="{{ .image.originalImageURL | replaceRE "(.+/)[^/]+" "$1" }}{{ .image.croppedImageURL }}">{{ end }}
    <ul class="list pl0 w-100 flex {{ if $has_image }}flex-wrap flex-row{{ else }}flex-column{{ end }}">
    {{ range $k, $a := .answers }}
      <li class="{{ if $has_image }}w-50 w-third-ns{{ end }}">
        <a class="db dim ba b--black-20 mr2 mb2 pa2 shadow-4 no-underline bg-light-gray"
          v-bind:class="{ 'bg-lightest-blue': selected_answers[{{$i}}] == {{$k}} }"
          v-on:click="select_answer({{$i}},{{$k}})" href="#q{{ add $j 1 }}">
          {{ with .image }}<img class="w-100" src="{{ .originalImageURL | replaceRE "(.+/)[^/]+" "$1" }}{{ .croppedImageURL }}">{{ end }}
          {{ with .text }}<div class="{{ if not $has_image }}f4 f3-ns pa1 pa2-ns fw3{{ else }}f5 f4-ns fw5 pa2{{ end }}">{{ . }}</div>{{ end }}
        </a>
      </li>
    {{ end }}
    </ul>
    <hr class="">
  </div>
  {{ end }}
</main>

<script src="https://unpkg.com/vue"></script>
<script>
  var t = 0, app = new Vue({
    el: '#app',
    data: {
      done: false,
      selected_answers: [{{ range $quiz.questions }}null,{{ end }}],
    },
    methods: {
      select_answer: function (i, k) {
        if (this.done) return;
        if (this.selected_answers[i] == null) t++;
        Vue.set(this.selected_answers, i, k);
        if (t == this.selected_answers.length) this.show_result();
      },
      show_result() {
        if (this.done) return;
        this.done = true;
        console.log('DONE');
      }
    }
  })
</script>

{{ if $debug }}
<script>
  console.log("Question:");
  console.log({{ index $quiz.questions 0 }});

  console.log("Result:");
  console.log({{ index $quiz.results 0 }});
</script>
{{ end }}

{{ end }}
