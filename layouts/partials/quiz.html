{{ $quiz := getJSON .Params.json_file }}
{{ $page := . }}
{{ $debug := ne (getenv "HUGO_ENV") "production" }}

<div class="pb3">
  <p class="lh-copy measure fw4 f4 f3-ns">{{ .Params.description }}</p>
</div>

<section id="app">
{{ range $i, $q := $quiz.questions }}
{{ $j := add $i 1 }}
<div id="q{{ $j }}" class="w-100 mb4">
  <h2 class="f4 f2-ns lh-title">{{ $j }}. {{ .text }}</h2>
  {{ $has_image := index (0 | index .answers) "image"  }}
  {{ if and .image (or (not $has_image) (not .text)) }}<img class="w-100 w-60-ns br4 o-80" src="{{ .image.originalImageURL | replaceRE "(.+/)[^/]+" "$1" }}{{ .image.croppedImageURL }}">{{ end }}
  <ul class="list pl0 w-100 flex {{ if $has_image }}flex-wrap flex-row{{ else }}flex-column{{ end }}">
  {{ range .answers }}
    <li class="{{ if $has_image }}w-50 w-third-ns{{ end }}">
      <a id="{{ .id }}"
        class="db dim ba b--black-20 mr2 mb2 pa2 shadow-4 no-underline bg-light-gray"
        v-bind:class="{ 'bg-light-blue': selected_answers[{{$i}}] == '{{ .id }}' }"
        v-on:click="select_answer({{ $i }}, '{{ .id }}', $event)" href="#q{{ add $j 1 }}">
        {{ with .image }}<img class="w-100" src="{{ .originalImageURL | replaceRE "(.+/)[^/]+" "$1" }}{{ .croppedImageURL }}">{{ end }}
        {{ with .text }}<div class="{{ if not $has_image }}f4 f3-ns pa1 pa2-ns fw3{{ else }}f5 f4-ns fw5 pa2{{ end }}">{{ . }}</div>{{ end }}
      </a>
    </li>
  {{ end }}
  </ul>
  <hr class="">
</div>
{{ end }}

<div id="result" class="mt5" v-bind:class="{ db: !done }">
  <h2 class="f3 f2-ns lh-title">Kết quả:</h2>
  {{ range $quiz.results }}
  <div id="{{ .id }}" class="shadow-2 pa3" v-bind:class="{ db: done != '{{ .id }}' }">
    <h1 class="ttu tracked lh-title">{{ .title }}</h1>
    {{ $page.Scratch.Set "result_image" (printf "https:%s" $page.Params.cover_image) }}
    {{ if .image }}
      {{ $page.Scratch.Set "result_image" (printf "https:%s%s" (.image.originalImageURL | replaceRE "(.+/)[^/]+" "$1") .image.croppedImageURL) }}
      <img class="w-100 w-60-ns br4 o-80" src="{{ $page.Scratch.Get "result_image" }}">
    {{ end }}
    <div>
      <a class="no-underline near-white bg-animate bg-dark-blue hover-bg-blue hover-white inline-flex items-center ma2 tc br2 pa2"
        v-on:click="fb_share({ title:'Tôi được: {{ .title }}', desc:'Cho {{ $page.Params.title }} | Kết quả của bạn là gì?', image:'{{ $page.Scratch.Get "result_image" }}' }, $event)"
        title="Facebook share">
        <svg class="dib h2 w2" fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill-rule="evenodd" clip-rule="evenodd" stroke-linejoin="round" stroke-miterlimit="1.414"><path d="M15.117 0H.883C.395 0 0 .395 0 .883v14.234c0 .488.395.883.883.883h7.663V9.804H6.46V7.39h2.086V5.607c0-2.066 1.262-3.19 3.106-3.19.883 0 1.642.064 1.863.094v2.16h-1.28c-1 0-1.195.476-1.195 1.176v1.54h2.39l-.31 2.416h-2.08V16h4.077c.488 0 .883-.395.883-.883V.883C16 .395 15.605 0 15.117 0" fill-rule="nonzero"/></svg><span class="f4 ml3 pr2">Chia sẻ cùng bạn bè</span></a>
    </div>
    {{ if .text }}<p class="lh-copy measure fw4 f4 f3-ns">
      {{ .text | replaceRE "\n" "<br>" | markdownify | safeHTML }}</p>{{ end }}
  </div>
  {{ end }}
</div>
</section>

<script src="https://unpkg.com/vue"></script>
<script>
function scrollToResult() {
  var obj = document.getElementById("result");
  if (false && obj.scrollIntoView) obj.scrollIntoView(); else {
    var curtop = 0;
     if (obj.offsetParent) {
       do {
           curtop += obj.offsetTop;
       } while (obj = obj.offsetParent);
     }
     // console.log('scroll', curtop);
     window.scroll(0, curtop);
  }
}

var t = 0, app = new Vue({
  el: '#app',
  data: {
    done: false,
    selected_answers: [{{ range $quiz.questions }}null,{{ end }}],
    qa_scores: [ {{ range $quiz.questions }} { {{ range .answers }}"{{.id}}": {{ .results }}, {{ end }} }, {{ end }} ],
    scores: { {{ range $quiz.results }} "{{.id}}": 0 , {{ end }} }
  },
  methods: {
    select_answer: function (i, k, event) {
      if (this.done) { event.preventDefault(); return; }
      if (this.selected_answers[i] == null) t++; else event.preventDefault();
      Vue.set(this.selected_answers, i, k);
      if (t == this.selected_answers.length) {
        event.preventDefault();
        this.show_result();
        window.setTimeout(function(){ scrollToResult(); }, 300);
      }
    },
    show_result() {
      if (this.done) return;
      var i, a, r, rs;
      for (i = 0; i < t; i++) {
        a = this.selected_answers[i];
        rs = this.qa_scores[i][a];
        for (r in rs) {
          this.scores[r] = this.scores[r] + parseInt(rs[r]);
        }
      }
      a = 0;
      for (r in this.scores) {
        rs = this.scores[r];
        if (rs > a) {
          a = rs;
          this.done = r;
        }
      }
      console.log('DONE', this.done);
    },
    fb_share(data, event) {
      event.preventDefault();
      var link = '{{ .Permalink }}?name="' + data.title + '"&picture=' + data.image;
      console.log(link, data);
      // https://www.facebook.com/v2.7/dialog/feed?app_id=685543434893182&channel_url=https%3A//staticxx.facebook.com/connect/xd_arbiter/r/lY4eZXm_YWu.js%3Fversion%3D42%23cb%3Df10a2a01e99f43%26domain%3Dvn.vonvon.me%26origin%3Dhttps%253A%252F%252Fvn.vonvon.me%252Ffa5e00ce9ce8f4%26relation%3Dopener&description=CLICK%20v%C3%A0%20xem%20ngay%20cho%20b%E1%BA%A1n!&display=popup&e2e=%7B%7D&hashtag=%23vonvon&link=https%3A//vn.vonvon.me/quiz/r/5770/26989/v_11y2r2frftktb0nzp%3Futm_campaign%3Dshare%26utm_source%3Dfacebook%26utm_medium%3Dorganic%26share_ts%3Dozfwx2%26utm_viral%3D27&locale=vi_VN&name=H%C3%ACnh%20%E1%BA%A3nh%20con%20g%C3%A1i%20t%C6%B0%C6%A1ng%20lai%20c%E1%BB%A7a%20Tu%E1%BB%99c%20Alex!&next=https%3A//staticxx.facebook.com/connect/xd_arbiter/r/lY4eZXm_YWu.js%3Fversion%3D42%23cb%3Df27d760dda4961%26domain%3Dvn.vonvon.me%26origin%3Dhttps%253A%252F%252Fvn.vonvon.me%252Ffa5e00ce9ce8f4%26relation%3Dopener%26frame%3Df368938f8a1743%26result%3D%2522xxRESULTTOKENxx%2522&picture=https%3A//vn-cdn.vonvon.me/api/i/5770/26989/thumbnail/2.v_11y2r2frftktb0nzp&sdk=joey&version=v2.7
      FB.ui(
        {
          method: 'feed',
          link: link
        },
        function(response) {
          if (response && !response.error_code) {
            window.shared_on_facebook = true;
            console.log('Success sharing to Facebook.');
            $("#resultPopup").modal("hide");
          } else {
            console.log('Error sharing to Facebook.');
          }
        }
      );
    }
  } // methods:
})
</script>

{{ if $debug }}
<script>
console.log("Question:");
console.log({{ index $quiz.questions 0 }});

console.log("Result:");
console.log({{ index $quiz.results 0 }});
</script>
{{ end }}
